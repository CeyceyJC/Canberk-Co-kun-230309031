//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

interface Storable {
    String getStorageKey();
    String toStorageString();

//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

public class Supplier {

    private String supplierId;
    private String name;
    private String email;
    private String phone;

    public Supplier(String supplierId, String name, String email, String phone) {
        this.supplierId = supplierId;
        this.name = name;
        this.email = email;
        this.phone = phone;
    }

    public String getSupplierId() {
        return supplierId;
    }

    public String getName() {
        return name;
    }

    public void setName(String name) {
        this.name = name;
    }
}

//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

public class Product implements Storable {

    private String productId;
    private String name;
    private double price;
    private int stock;
    private int minStock;
    private Supplier supplier;

    public Product(String productId, String name, double price,
                   int stock, Supplier supplier, int minStock) {

        this.productId = productId;
        this.name = name;
        this.price = price;
        this.stock = stock;
        this.supplier = supplier;
        this.minStock = minStock;
    }

    public String getProductId() {
        return productId;
    }

    public String getName() {
        return name;
    }

    public double getPrice() {
        return price;
    }

    public int getStock() {
        return stock;
    }

    public int getMinStock() {
        return minStock;
    }

    public Supplier getSupplier() {
        return supplier;
    }

    public void increaseStock(int amount) {
        stock += amount;
    }

    public boolean decreaseStock(int amount) {
        if (amount > stock) {
            return false;
        }
        stock -= amount;
        return true;
    }

    public boolean isLowStock(int threshold) {
        return stock <= threshold;
    }

    @Override
    public String getStorageKey() {
        return productId;
    }

    @Override
    public String toStorageString() {
        return productId + "," + name + "," + price + "," + stock;
    }

    @Override
    public String toString() {
        return productId + " | " + name + " | Stok: " + stock;
    }
}

//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

import java.timr.LocalDate;
import java.util.Objects;

class PerishableProduct extends Product {
    private LocalDate experiyDate;

    public PerishableProduct (String productId, String name, double price, int stock, Supplier supplier, int minStock, LocalDate expiryDate) {
        super (productId, name, price, stock, supplier, minStock, expiryDate);
        this.expiryDate = Objects.requireNonNull(expiryDate);
    }

    @Override
    public String toStorageString() {
        return String.join(",",
            "PerishableProduct",
            escape(getProductId()),
            escape(getName()),
            String.valueOf(getPrice()),
            String.valueOf(getStock()),
            escape(()),
            escape(()),
            String.valueOf(getMinStock()),
            expirtDate.toString()
        };
    }

    @override
    public String toString() {
        return "PerishableProduct(Product Id = " + getProductId() + ", name= " + getName() + ", price" + getPrice() + ", stock= " + getStock() + ", supplier= " + getSupplier().getName() +", minStock= " + getMinStock() + ", expiry= " + expiryDate + ", expired= " + isExpired() + "}";
    }
}

//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

import java.timr.LocalDate;
import java.util.Objects;

class Order {
    private final String orderId;
    private final String productId;
    private final int quantity;
    private final LocalDate orderDate;
    private String status;

    public Order(String orderId, String productId, int quantity, String status) {
    this.orderId = Objects.requireNonNull(orderId);
    this.productId = Objects.requireNonNull(productId);
    if (quantity <= 0) throw new IllegalArguementException("Adet pozitif olmalı.");
    this.quantity = quantity;
    this.orderDate = LocalDate.now();
    this.status = Objects.requireNonNull(status);
    }

public String getOrderId() { return orderId; }
public String getProductId() { return productId; }
public int getQuantity() { return quantity; }
public LocalDate getOrderDate() { return orderDate; }
public String getStatus() { return status; }
public void getStatus(String status) { this.status = Objects.requireNonNull(status); }

@Override
public String toString() {
    return "Order Id =" + orderId + "\nProduct Id = " + productId + "\nQuantity = " + quantity + "\nDate of Order = " + orderDate + "\nStatus = " + status ;
    }
}

//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

import java.io.*;
import java.time.LocalDate;
import java.util.*;

class Inventory {
    private final Map<String, Product> products = new LinkedHashMap<>();
    private final Map<String, Supplier> suppliers = new LinkedHashMap<>();

    public void addSupplier(Supplier supplier) {
        suppliers.put(supplier.getSupplierId(), supplier);
    }

    public Supplier getSupplier(String supplierId) {
        return suppliers.get(supplierId);
    }

    public boolean addProduct(Product product) {
        if (products.containsKey(product.getProductId())) 
            return false;
        products.put(product.getProductId(), product);
            return true;
    }

    public Product removeProduct(String productId) {
        return products.remove(productId);
    }

    public Product getProduct(String productId) {
        return products.get(productId);
    }

    public List<Product> searchByName(String keyword) {
        String k = (keyword == null) ? "" : keyword.toLowerCase(Locale.ROOT);
        List<Product> result = new ArrayList<>();
        for (Product p : products.values()) {
            if (p.getName().toLowerCase(Locale.ROOT).contains(k)) result.add(p);
        }
        return result;
    }

    public Collection<Product> listAllProducts() {
        return products.values();
    }

    public void saveToFile(String path) throws IOException {
        try (BufferedWriter bw = new BufferedWriter(new FileWriter(path))) {
            bw.write("type,productId,name,price,stock,supplierId,supplierName,minStock,expiryDate");
            bw.newLine();
            for (Product p : products.values()) {
                bw.write(p.toStorageString());
                bw.newLine();
            }
        }
    }

    public static Inventory loadFromFile(String path) throws IOException {
        Inventory inv = new Inventory();

        try (BufferedReader br = new BufferedReader(new FileReader(path))) {
            String header = br.readLine();
            if (header == null) return inv;

            String line;
            while ((line = br.readLine()) != null) {
                List<String> cols = parseCsvLine(line);
                if (cols.size() < 9) continue;

                String type = cols.get(0);
                String productId = cols.get(1);
                String name = cols.get(2);
                double price = Double.parseDouble(cols.get(3));
                int stock = Integer.parseInt(cols.get(4));
                String supplierId = cols.get(5);
                String supplierName = cols.get(6);
                int minStock = Integer.parseInt(cols.get(7));
                String expiryDateStr = cols.get(8);

                Supplier sup = inv.getSupplier(supplierId);
                if (sup == null) {
                    sup = new Supplier(supplierId, supplierName, null, null);
                    inv.addSupplier(sup);
                }

                if ("PerishableProduct".equals(type) && expiryDateStr != null && !expiryDateStr.isBlank()) {
                    inv.addProduct(new PerishableProduct(productId, name, price, stock, sup, minStock, LocalDate.parse(expiryDateStr)));
                } else {
                    inv.addProduct(new Product(productId, name, price, stock, sup, minStock));
                }
            }
        }
        return inv;
    }

    private static List<String> parseCsvLine(String line) {
        List<String> out = new ArrayList<>();
        StringBuilder cur = new StringBuilder();
        boolean inQuotes = false;
        
            for (int i = 0; i < line.length(); i++) {
            char c = line.charAt(i);
            if (c == '"') {
                if (inQuotes && i + 1 < line.length() && line.charAt(i + 1) == '"') {
                    cur.append('"');
                    i++;
                } else {
                    inQuotes = !inQuotes;
                }
            } else if (c == ',' && !inQuotes) {
                out.add(cur.toString());
                cur.setLength(0);
            } else {
                    cur.append(c);
            }
        }
        out.add(cur.toString());
        return out;
    }
}

//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

import java.io.IOException;
import java.util.Collection;
import java.util.List;

class StockManager {
    private final Inventory inventory = new Inventory();

    public Inventory getInventory() { return inventory; }

    public boolean addProduct(Product product) {
        boolean ok = inventory.addProduct(product);
        if (!ok) System.out.println("Uyarı: Bu ID ile ürün zaten var -> " + product.getProductId());
        return ok;
    }

    public Product removeProduct(String productId) {
        Product removed = inventory.removeProduct(productId);
        if (removed == null) System.out.println("Uyarı: Ürün bulunamadı -> " + productId);
        return removed;
    }

    public void updateStock(String productId, int delta) {
        Product p = inventory.getProduct(productId);
        if (p == null) {
            System.out.println("Uyarı: Ürün yok -> " + productId);
            return;
        }

        if (delta > 0) {
            p.increaseStock(delta);
        } else if (delta < 0) {
            int amount = Math.abs(delta);
            boolean ok = p.decreaseStock(amount);
            if (!ok) System.out.println("Uyarı: Stok yetersiz! İstenen=" + amount + ", Mevcut=" + p.getStock());
        } else {
            System.out.println("Bilgi: Delta 0, değişiklik yok.");
        }

        System.out.println("Güncel stok: " + p.getProductId() + " -> " + p.getStock());
    }

    public List<Product> searchByName(String keyword) {
        return inventory.searchByName(keyword);
    }

    public void printLowStockWarnings(int threshold) {
        for (Product p : inventory.listAllProducts()) {
            if (p.isLowStock(threshold)) {
                System.out.println("AZ STOK! " + p.getProductId() + " | " + p.getName() + " | Stok=" + p.getStock());
            }
        }
    }

    public Order createOrder(String orderId, String productId, int qty) {
        Product p = inventory.getProduct(productId);
        if (p == null) {
            System.out.println("Uyarı: Sipariş ürünü bulunamadı -> " + productId);
            return new Order(orderId, productId, qty, "FAILED");
        }

        boolean ok = p.decreaseStock(qty);
        if (!ok) {
            System.out.println("Sipariş başarısız: stok yetersiz. Ürün=" + p.getName() + ", Stok=" + p.getStock());
            return new Order(orderId, productId, qty, "FAILED");
        }

        System.out.println("Sipariş tamamlandı -> " + orderId);
        return new Order(orderId, productId, qty, "COMPLETED");
    }

    public void autoRestockAll() {
        for (Product p : inventory.listAllProducts()) {
            if (p.getStock() < p.getMinStock()) {
                int need = p.getMinStock() - p.getStock();
                p.increaseStock(need);
                System.out.println("AutoRestock: " + p.getProductId() + " +" + need + " (Yeni=" + p.getStock() + ")");
            }
        }
    }

    public double averagePrice() {
        Collection<Product> all = inventory.listAllProducts();
        if (all.isEmpty()) return 0.0;
        double sum = 0;
        for (Product p : all) sum += p.getPrice();
        return sum / all.size();
    }

    public Product mostExpensiveProduct() {
        Product best = null;
        for (Product p : inventory.listAllProducts()) {
            if (best == null || p.getPrice() > best.getPrice()) best = p;
        }
        return best;
    }

    public void saveToFile(String path) throws IOException {
        inventory.saveToFile(path);
    }

    public void listAll() {
        inventory.listAllProducts().forEach(System.out::println);
    }
}

//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
